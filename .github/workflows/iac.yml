name: ğŸ›¡ï¸ AnÃ¡lise de IaC com Checkov

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  checkov:
    name: ğŸ” AnÃ¡lise de SeguranÃ§a IaC - Checkov
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ› ï¸ Checkout do RepositÃ³rio
        uses: actions/checkout@v4

      - name: ğŸ“¦ Instalando Checkov
        run: |
          pip install checkov

      - name: ğŸ›¡ï¸ Executando Checkov
        run: |
          checkov -d . --compact --output json > checkov.json

      - name: ğŸ“Š Exportando resultados em Markdown
        run: |
          echo "### ğŸ›¡ï¸ Resultados do Checkov" > checkov-findings.md
          echo "" >> checkov-findings.md
          echo "| RECURSO             | ID DA REGRA      | SEVERIDADE | ARQUIVO               | LINHA |" >> checkov-findings.md
          echo "|----------------------|------------------|------------|-----------------------|-------|" >> checkov-findings.md
          
          cat checkov.json | jq -r '
            .results.failed_checks[] |
            "| \(.resource) | \(.check_id) | \(.severity) | \(.file_path) | \(.file_line_range[0]) |"
          ' >> checkov-findings.md

          echo ""
          echo "âœ… Arquivo checkov-findings.md gerado com sucesso!"
          cat checkov-findings.md

      - name: ğŸ’¬ Gerando resultado no Pull Request
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: ğŸ›¡ï¸ Resultados do Checkov
          path: checkov-findings.md
