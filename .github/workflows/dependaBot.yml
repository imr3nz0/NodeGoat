name: Fetch Dependabot Alerts with Table and Comment

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  dependabot-scan:
    runs-on: ubuntu-latest
    env:
      REPO: ${{ github.event.inputs.repo || github.repository }}
      GITHUB_TOKEN: ${{ secrets.TOKENALERT }}

    steps:
      - name: 📥 Baixar Dependabot Alerts e salvar em alerts.json
        run: |
          echo "Fetching Dependabot alerts for repository: $REPO"

          page=1
          echo "[]" > alerts.json

          while true; do
            echo "Fetching page: $page"
            response=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPO/dependabot/alerts?per_page=100&state=open&page=$page")

            # 🟩 Valida tipo antes de somar
            if echo "$response" | jq -e 'type == "array"' >/dev/null; then
              jq -s '.[0] + .[1]' alerts.json <(echo "$response") > tmp.json && mv tmp.json alerts.json
            else
              echo "⚠️ Resposta não é um array! Erro retornado pela API:"
              echo "$response"
              break
            fi

            count=$(echo "$response" | jq length)
            if [ "$count" -lt 100 ]; then
              echo "No more pages."
              break
            fi
            page=$((page+1))
          done

          echo "✅ Alerts salvos em alerts.json"

      - name: 🔍 Filtrar e imprimir resultados no log
        run: |
          echo "🎯 Resultados filtrados:"
          cat alerts.json | jq -r '
            .[] | {
              severity: .security_advisory.severity,
              summary: .security_advisory.summary,
              manifest_path: .dependency.manifest_path,
              package: "\(.dependency.package.ecosystem):\(.dependency.package.name)"
            }
          '

      - name: 📊 Exportando resultados em Markdown
        id: create-table
        run: |
          echo "### 🛡️ Resultados do Dependabot" > findings.md
          echo "" >> findings.md
          echo "| PACOTE               | STATUS      | CAMINHO                  | SEVERIDADE | URL                       |" >> findings.md
          echo "|----------------------|-------------|--------------------------|------------|---------------------------|" >> findings.md

          cat alerts.json | jq -r '
            .[] |
            "| \(.dependency.package.ecosystem):\(.dependency.package.name) | VULNERÁVEL | \(.dependency.manifest_path) | \(.security_advisory.severity) | \(.html_url) |"
          ' >> findings.md

          echo ""
          echo "✅ Arquivo findings.md gerado com sucesso!"
          cat findings.md

      - name: 💬 Gerar comentário no Pull Request
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: 🚀 Resultados do Dependabot
          path: findings.md
